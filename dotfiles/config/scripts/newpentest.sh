#!/bin/bash

# Define the base directory, default if not provided
base_dir="${1:-New-PentTest}"

# Create directories using a nested structure
mkdir -p "$base_dir"/{Admin,Deliverables,Notes,Evidence/{Findings,Scans/{Vuln,Service,Web,'AD Enumeration'},Screenshots,OSINT,Wireless,'Logging output','Misc Files'},Retest}

# Define an array with all Markdown file paths relative to the base directory
md_files=(
    "Evidence/Findings/H1-Kerberoasting"
    "Evidence/Findings/H2-ASREPRoasting"
    "Evidence/Findings/H3-LLMNR-NBT-NS-Response-Spoofing"
    "Notes/0.Kill-Chain"
    "Notes/1.Administrative-Information"
    "Notes/2.Scoping-Information"
    "Notes/3.Activity-Log"
    "Notes/4.Payload-Log"
    "Notes/5.OSINT-Data"
    "Notes/6.Credentials"
    "Notes/7.Web-application-Research"
    "Notes/8.Vulnerability-Scan-Research"
    "Notes/9.Service-Enumeration-Research"
    "Notes/10.AD-Enumeration-Research"
    "Notes/11.Attack-Path"
    "Notes/12.Findings"
    "Notes/13.Network-Information"
)

# Create all markdown files from the array if they do not exist
for md_file in "${md_files[@]}"; do
    if [ ! -f "$base_dir/$md_file.md" ]; then
        touch "$base_dir/$md_file.md"
    fi
done

# Check if the org file already exists before copying
if [ ! -f "$base_dir/Pentest.org" ]; then
    cp ~/.config/orgTemplates/Pentest.org "$base_dir/Pentest.org"
else
    echo "Org file already exists, not copying over."
fi

# Update the index file
update_index() {
    echo "# Index of Markdown Files" > "$base_dir/Index.md"
    find "$base_dir" -type f -name "*.md" ! -name "Index.md" | sort | while read md_file; do
        rel_path="${md_file#$base_dir/}"
        echo "- [[${rel_path%.md}]]" >> "$base_dir/Index.md"
    done
}

update_index  # Call the function to ensure the index is always up to date

# Confirmation message
echo "Folder structure, files, and index have been updated in $base_dir."
